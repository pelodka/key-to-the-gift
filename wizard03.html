<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Czech Wizard — Tax Puzzle</title>
  <script src="audio.js"></script>
  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:black; font-family:'Courier New', monospace; }
    #wrapper { position:absolute; top:0; left:0; width:1920px; height:1200px; transform-origin:top left; }
    #game-container { position:relative; width:100%; height:100%; background:url('background.png') center/cover no-repeat; }
    #player { position:absolute; width:320px; height:320px; bottom:80px; background:url('player_idle.png') center/contain no-repeat; image-rendering:pixelated; }
    #player.flipped { transform:scaleX(-1); }
    #player.hands { background:url('player_hands.png') center/contain no-repeat; }
    .collect-block { position:absolute; width:60px; height:40px; background:black; cursor:pointer; image-rendering:pixelated; }
    #wizard { position:absolute; width:300px; height:300px; bottom:80px; left:50%; transform:translateX(-50%); pointer-events:none; }
    #wizard img { width:100%; height:100%; image-rendering:pixelated; }
    #prompt { position:absolute; bottom:calc(100% + 10px); left:50%; transform:translateX(-50%);
      background:white; color:black; padding:8px 12px; border:4px solid red; border-radius:4px;
      font-size:28px; font-family:'Arial Black'; text-transform:uppercase; pointer-events:none; display:none; }
    #puzzle-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; z-index:100;
    }
    #puzzle-box {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:white; padding:32px; border:4px solid black; width:800px; max-width:90vw; font-family:'Courier New', monospace;
    }
    #dialog-name { text-align:center; font-size:28px; font-weight:bold; margin-bottom:16px; }
    #dialog-text { text-align:center; font-size:24px; margin-bottom:24px; }
    .blocks-container { display:grid; grid-template-columns:1fr; gap:8px; max-height:300px; overflow-y:auto; margin-bottom:24px; }
    .block { padding:12px; background:#eee; border:2px solid #333; cursor:grab; user-select:none; font-size:20px; }
    .drop-areas { display:flex; justify-content:space-between; flex-wrap:wrap; }
    .drop-area-container { width:45%; margin:5px 0; display:none; }
    .drop-area {
      width:100%; min-height:80px; border:3px dashed #333; display:flex; align-items:center; justify-content:center;
      font-size:22px; font-weight:bold; user-select:none;
    }
  </style>
</head>
<body>
  <div id="wrapper">
    <div id="game-container">
      <div id="player"></div>
      <div id="wizard">
        <img src="wizard3.png" alt="Wizard" />
        <div id="prompt">Press E</div>
      </div>

      <!-- TAX Puzzle Overlay -->
      <div id="puzzle-overlay">
        <div id="puzzle-box">
          <div id="dialog-name"></div>
          <div id="dialog-text"></div>
          <div id="blocks" class="blocks-container"></div>
          <div class="drop-areas">
            <div class="drop-area-container"><div id="germanyArea" class="drop-area">ГЕРМАНИЯ</div></div>
            <div class="drop-area-container"><div id="russiaArea"   class="drop-area">РОССИЯ</div></div>
            <div class="drop-area-container"><div id="portugalArea"class="drop-area">ПОРТУГАЛИЯ</div></div>
            <div class="drop-area-container"><div id="armeniaArea" class="drop-area">АРМЕНИЯ</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Scaling
    function updateScale() {
      const vw=innerWidth, vh=innerHeight, scale=Math.min(vw/1920, vh/1200);
      const w=document.getElementById('wrapper');
      w.style.transform = `scale(${scale})`;
      w.style.left = `${(vw-1920*scale)/2}px`;
      w.style.top  = `${(vh-1200*scale)/2}px`;
    }
    addEventListener('resize', updateScale);
    updateScale();

    // Refs & state
    const player = document.getElementById('player'),
          gameArea = document.getElementById('game-container'),
          prompt = document.getElementById('prompt'),
          overlay = document.getElementById('puzzle-overlay'),
          nameEl = document.getElementById('dialog-name'),
          textEl = document.getElementById('dialog-text'),
          blocksDiv = document.getElementById('blocks');
    const cases = [
      {text:'Вы купили акции и продали через год без налога', country:'ПОРТУГАЛИЯ'},
      {text:'Не указан доход из Грузии — штраф 10k',           country:'ГЕРМАНИЯ'},
      {text:'Работа за границей облагается налогом с первого дня', country:'АРМЕНИЯ'},
      {text:'Имущественный вычет за покупку квартиры',          country:'РОССИЯ'}
    ];
    const zones = {
      germanyArea:'ПОРТУГАЛИЯ', russiaArea:'РОССИЯ',
      portugalArea:'ПОРТУГАЛИЯ', armeniaArea:'АРМЕНИЯ'
    };
    let interaction=false, placed=0, puzzleSolved=false, waitingBlock=false;
    const params=new URLSearchParams(location.search),
          exit=params.get('exit'),
          leftLimit=0,
          rightLimit=gameArea.clientWidth-player.clientWidth,
          spawnX=(exit==='left'?rightLimit:leftLimit);
    player.style.left=spawnX+'px';
    player.style.bottom='80px';

    // Start puzzle
    function startDialog(){
      interaction=true;
      overlay.style.display='block';
      nameEl.textContent='';
      textEl.textContent='Саша, твои налоговые навыки нужны! Распредели кейсы по странам.';
      const proceed=e=>{
        if(e.type==='keydown'&&e.key==='e')return;
        removeEventListener('keydown',proceed);
        removeEventListener('mousedown',proceed);
        showPuzzle();
      };
      addEventListener('keydown',proceed);
      addEventListener('mousedown',proceed);
    }

    function showPuzzle(){
      nameEl.textContent='TAX PUZZLE';
      textEl.textContent='';
      blocksDiv.innerHTML='';
      cases.forEach((c,i)=>{
        const d=document.createElement('div');
        d.className='block';
        d.textContent=c.text;
        d.draggable=true;
        d.id='case'+i;
        d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',d.id));
        blocksDiv.appendChild(d);
      });
      document.querySelectorAll('.drop-area-container').forEach(c=>c.style.display='block');
    }

    // Drag & Drop
    function allowDrop(e){e.preventDefault();}
    function drag(e){e.dataTransfer.setData('text/plain',e.target.id);}
    function drop(e){
      e.preventDefault();
      const id=e.dataTransfer.getData('text/plain'),
            block=document.getElementById(id),
            zone=e.currentTarget.id,
            correct=cases.find(c=>c.text===block.textContent).country===zones[zone];
      if(correct){
        block.remove(); placed++;
        if(placed===cases.length) finishPuzzle();
      } else {
        textEl.textContent='Неправильно. Попробуй снова.';
        setTimeout(()=>textEl.textContent='',2000);
      }
    }
    Object.keys(zones).forEach(z=>{
      const el=document.getElementById(z);
      el.addEventListener('dragover',allowDrop);
      el.addEventListener('drop',drop);
    });

    // Finish & spawn collectible
    function finishPuzzle(){
      nameEl.textContent='';
      blocksDiv.style.display='none';
      document.querySelectorAll('.drop-area-container').forEach(c=>c.style.display='none');
      textEl.textContent='Отлично! Подсказка: TAX1';
      puzzleSolved=true;
      const proceed=e=>{
        if(e.type==='keydown'&&e.key==='e')return;
        removeEventListener('keydown',proceed);
        removeEventListener('mousedown',proceed);
        overlay.style.display='none';
        spawnCollectible();
      };
      addEventListener('keydown',proceed);
      addEventListener('mousedown',proceed);
    }

    function spawnCollectible(){
      waitingBlock=true;
      player.classList.add('hands');
      const blk=document.createElement('div');
      blk.className='collect-block';
      blk.style.left=(player.offsetLeft+(320-60)/2)+'px';
      blk.style.bottom=(80+320+10)+'px';
      gameArea.appendChild(blk);
      blk.addEventListener('click',()=>{
        blk.style.transition='all .5s ease-out';
        blk.style.left='0px';
        blk.style.bottom=(gameArea.clientHeight-40)+'px';
        blk.addEventListener('transitionend',()=>{
          blk.remove();
          waitingBlock=false;
          player.classList.remove('hands');
        },{once:true});
      });
    }

    // Movement & loop
    let keys={}, isJump=false, speed=0, grav=0.8;
    function checkProx(){
      const wx=(gameArea.clientWidth-player.clientWidth)/2;
      prompt.style.display=!waitingBlock && !interaction && Math.abs(player.offsetLeft-wx)<192 ? 'block' : 'none';
    }
    function loop(){
      if(!waitingBlock&&!isJump){
        if(keys['arrowleft']||keys['a']){
          player.style.left=Math.max(0,player.offsetLeft-4)+'px';
          player.classList.add('flipped');
        }
        if(keys['arrowright']||keys['d']){
          player.style.left=Math.min(gameArea.clientWidth-player.clientWidth,player.offsetLeft+4)+'px';
          player.classList.remove('flipped');
        }
        if((keys[' ']||keys['arrowup']||keys['w'])&&!isJump){
          isJump=true; speed=15; window.audio.playJump();
        }
      }
      if(isJump){
        let b=parseFloat(player.style.bottom)||80;
        player.style.bottom=(b+speed)+'px';
        speed-=grav;
        if(b+speed<=80){ player.style.bottom='80px'; isJump=false; }
      }
      checkProx();
      requestAnimationFrame(loop);
    }
    loop();

    // Input
    addEventListener('keydown',e=>{
      keys[e.key.toLowerCase()]=true;
      if(e.key==='e'&&!interaction) startDialog();
      if(e.key==='e' && puzzleSolved){
        const px=player.offsetLeft;
        if((e.key==='ArrowLeft'||e.key==='a')&&px<=leftLimit)  location=`chest.html?exit=left`;
        if((e.key==='ArrowRight'||e.key==='d')&&px>=rightLimit) location=`chest.html?exit=right`;
        window.location.href = location;
      }
    });
    addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
  </script>
</body>
</html>
